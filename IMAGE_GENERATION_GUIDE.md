# Image Generation Test Scripts

Quick reference for testing the Flux image generation capability.

## Quick Start

### 1. Simple Image Generation

Generate a single image with default settings:

```bash
API_KEY=sk-proj-... ./scripts/api/generate-image.sh
```

### 2. Custom Prompt

Generate an image with a custom prompt:

```bash
API_KEY=sk-proj-... ./scripts/api/generate-image.sh "gpt-image-1" "A serene beach at sunset"
```

### 3. Custom Size and Format

```bash
API_KEY=sk-proj-... ./scripts/api/generate-image.sh "gpt-image-1" "A mountain landscape" "1024x1024" "url"
```

### 4. Save Output

```bash
API_KEY=sk-proj-... ./scripts/api/generate-image.sh "gpt-image-1" "A futuristic city" "1024x1024" "url" "/tmp/my-image.json"
```

## Comprehensive Test Suite

Run all test cases to verify the image generation system:

```bash
API_KEY=sk-proj-... ./scripts/tests/test-image-generation.sh
```

### Tests Included

1. **Basic image generation** - gpt-image-1 model with URL format
2. **Alternative alias** - dall-e-3 model (maps to Flux)
3. **Base64 format** - b64_json response format
4. **Detailed prompt** - Long, complex prompt
5. **Abstract concepts** - Testing creative prompts
6. **Missing prompt** - Error handling (should fail)
7. **Missing model** - Error handling (should fail)
8. **Invalid model** - Error handling (should fail)

## Available Models

Both of these models map to Flux 2 Klein 9B:

- `gpt-image-1` - Primary alias
- `dall-e-3` - Alternative alias

## Response Formats

- `url` - Returns image as data URL (base64-encoded)
- `b64_json` - Returns base64-encoded JSON field

## Environment Variables

```bash
API_URL         # API endpoint (default: http://localhost:3000)
API_KEY         # API key (REQUIRED)
```

## Example: Full Test Workflow

```bash
#!/bin/bash

# Set your API key
export API_KEY="sk-proj-your-api-key-here"

# Run comprehensive tests
echo "Running comprehensive image generation tests..."
./scripts/tests/test-image-generation.sh

# Test with a specific prompt
echo ""
echo "Testing with custom prompt..."
./scripts/api/generate-image.sh "gpt-image-1" "A majestic eagle soaring over mountains"

# Test alternative model alias
echo ""
echo "Testing alternative model alias..."
./scripts/api/generate-image.sh "dall-e-3" "A underwater kingdom with bioluminescent creatures"

# Test base64 format
echo ""
echo "Testing base64 format..."
./scripts/api/generate-image.sh "gpt-image-1" "A dreamlike forest" "1024x1024" "b64_json"
```

## Troubleshooting

### 401 Unauthorized
- Check that `API_KEY` environment variable is set correctly
- Verify the API key is valid

### 400 Bad Request
- Ensure `model` and `prompt` are provided
- Check that the model name is valid (gpt-image-1 or dall-e-3)

### Connection Refused
- Verify the API is running at the correct URL
- Check `API_URL` environment variable (default: http://localhost:3000)

### Invalid JSON Response
- Verify the API server is running
- Check server logs for errors

## Output Files

Generated responses are saved as JSON. For the basic script:

```json
{
  "created": 1707427200,
  "data": [
    {
      "url": "data:image/png;base64,...",
      "revised_prompt": "..."
    }
  ],
  "model": "gpt-image-1"
}
```

## Integration with Onyx

When Onyx requests image generation:

1. Onyx sends request with model: `gpt-image-1`
2. Proxy maps to Cloudflare's Flux 2 Klein 9B
3. Image is generated by Flux
4. Response is returned showing model as `gpt-image-1` (transparent to Onyx)

This ensures Onyx thinks it's using OpenAI's GPT-Image-1 while actually using Cloudflare's Flux model.
